# ENSA Hoceima HR Module - Technical Documentation

## Part 1: Global Module Understanding

### 1. Module Overview
The `ensa_hoceima_hr` module is an advanced, enterprise-grade Human Resources and Student Management solution designed specifically for **Ã‰cole Nationale des Sciences AppliquÃ©es d'Al Hoceima (ENSAH)**. It extends Odoo's core HR capabilities to manage the unique academic-industrial ecosystem of an engineering school.

At its core, it integrates **Artificial Intelligence** to modernize traditional processes:
- **Smart Matching**: Connects students to internships and supervisors to projects using semantic analysis.
- **AI Assistant**: A natural language chatbot for querying HR and student data.
- **Predictive Analytics**: Forecasts performance trends and detects turnover risks or student difficulties.

### 2. Main Business Domains
*   **HR Management**: Extended employee profiles with skill matrices, certifications, and equipment tracking.
*   **Internships**: distinct management of student internships, including "Smart Matching" with companies.
*   **Student Projects**: Lifecycle management for academic projects (PFA/PFE), tracking budgets, deliverables, and outcomes.
*   **AI Assistant**: A chat interface for fetching data, generating summaries, and drafting documents.
*   **Dashboards & Analytics**: A React/Owl-based dashboard providing real-time insights into departmental performance and student success.
*   **Reports & Documents**: Generation of professional certificates, internship attestations, and evaluation reports using QWeb.

### 3. Module Loading Flow
Odoo loads the module in the following strict order, defined in [__manifest__.py](file:///c:/odoo-addons/ensa_hoceima_hr/__manifest__.py):
1.  **Manifest** ([__manifest__.py](file:///c:/odoo-addons/ensa_hoceima_hr/__manifest__.py)): Declares dependencies ([hr](file:///c:/odoo-addons/ensa_hoceima_hr/models/ai_assistant.py#107-166), `web`, etc.) and the file loading order.
2.  **Models** ([models/__init__.py](file:///c:/odoo-addons/ensa_hoceima_hr/models/__init__.py)): Python files define the database schema and business logic.
3.  **Security** (`security/`):
    - [security.xml](file:///c:/odoo-addons/ensa_hoceima_hr/security/security.xml) defines user groups (User, Officer, Manager).
    - [ir.model.access.csv](file:///c:/odoo-addons/ensa_hoceima_hr/security/ir.model.access.csv) defines CRUD rights for each group on each model.
4.  **Data** (`data/`): Loads initial reference data and scheduled actions.
5.  **Views** (`views/`): Defines the UI (Forms, Trees, Kanbans, Menus).
    - loaded in hierarchical order (Base menus -> Specific views -> Action menus).
6.  **Reports** ([report/](file:///c:/odoo-addons/ensa_hoceima_hr/models/internship.py#77-82)): Loads QWeb templates and report actions.
7.  **Assets** (`static/`): Loads CSS/SCSS and JavaScript for the frontend/dashboard.

---

## Part 2: File & Folder Explanation

| Path | type | Role & Interaction |
| :--- | :--- | :--- |
| **[__manifest__.py](file:///c:/odoo-addons/ensa_hoceima_hr/__manifest__.py)** | Config | The module's "passport". Defines name, version, dependencies, and the list of data files to load. |
| **[__init__.py](file:///c:/odoo-addons/ensa_hoceima_hr/__init__.py)** | Python | Makes the directory a Python package and imports the sub-folders (`models`, `controllers`, etc.). |
| **`controllers/`** | Folder | Handles HTTP requests and API endpoints. |
| [controllers/ai_controller.py](file:///c:/odoo-addons/ensa_hoceima_hr/controllers/ai_controller.py) | Python | **Critical**: Exposes JSON endpoints (`/ensa_hr/ai/chat`) used by the JS dashboard and Chatbot to communicate with the backend AI services. |
| **`models/`** | Folder | Defines database tables (ORM) and business logic. |
| [models/employee.py](file:///c:/odoo-addons/ensa_hoceima_hr/models/employee.py) | Python | Inherits `hr.employee`. Adds academic fields (Certifications, Skills) and smart buttons for Projects/Internships. |
| [models/student_project.py](file:///c:/odoo-addons/ensa_hoceima_hr/models/student_project.py) | Python | Manages student projects (PFE/PFA). Tracks status, budget, and supervisor assignment. |
| [models/internship.py](file:///c:/odoo-addons/ensa_hoceima_hr/models/internship.py) | Python | Manages internships. Contains the **Smart Matching** logic ([calculate_match_score](file:///c:/odoo-addons/ensa_hoceima_hr/models/internship.py#152-202)) linking students to offers. |
| [models/ai_assistant.py](file:///c:/odoo-addons/ensa_hoceima_hr/models/ai_assistant.py) | Python | Stores chat history and defines the [ask_question](file:///c:/odoo-addons/ensa_hoceima_hr/models/ai_assistant.py#18-62) method that calls `ensa.ai.service`. |
| **`services/`** | Folder | **Architectural Highlight**: Separates complex logic from models. |
| [services/ai_service.py](file:///c:/odoo-addons/ensa_hoceima_hr/services/ai_service.py) | Python | Wrapper for AI providers (HuggingFace, Bytez). Handles API calls for text generation. |
| [services/matching_engine.py](file:///c:/odoo-addons/ensa_hoceima_hr/services/matching_engine.py) | Python | Implements the math for matching (Cosine Similarity, Jaccard Index) used by [internship.py](file:///c:/odoo-addons/ensa_hoceima_hr/models/internship.py). |
| [services/document_generator.py](file:///c:/odoo-addons/ensa_hoceima_hr/services/document_generator.py) | Python | Uses AI to draft text for certificates and letters. |
| **[report/](file:///c:/odoo-addons/ensa_hoceima_hr/models/internship.py#77-82)** | Folder | QWeb PDF report definitions. |
| `report/*.xml` | XML | Templates for HTML/PDF rendering. [professional_reports.xml](file:///c:/odoo-addons/ensa_hoceima_hr/report/professional_reports.xml) defines the look of certificates. |
| **`security/`** | Folder | Access control. |
| [security/ir.model.access.csv](file:///c:/odoo-addons/ensa_hoceima_hr/security/ir.model.access.csv) | CSV | Access Control List (ACL). Defines who can Read/Write/Create/Unlink data. |
| **`static/src/js/`** | Folder | Frontend logic. |
| `dashboard_controller.js` | JS | **Owl Component**: The logic behind the dashboard. Fetches data via RPC and renders the UI. |
| **`views/`** | Folder | XML files defining the User Interface. |
| `views/dashboard_views.xml` | XML | Defines the client action that loads the JS Dashboard. |

---

## Part 3: Detailed Models Explanation

### 1. `ensa.student.project` (`models/student_project.py`)
*   **Purpose**: Tracks academic projects assigned to students under supervision.
*   **Key Fields**:
    - `supervisor_id`: Many2one to `hr.employee`. Links the HR side (Professor) to the Academic side.
    - `status`: Selection (Planning -> Completed). Drives the workflow.
    - `budget`, `final_grade`: Tracking metrics.
*   **Design Choice**: separated from standard Odoo projects to allow specific academic fields (Grade, Learning Outcomes) without polluting the generic Project module.

### 2. `ensa.internship` (`models/internship.py`)
*   **Purpose**: Manages the internship lifecycle and facilitates student-company matching.
*   **Key Fields**:
    - `student_skills`, `required_skills`: Text fields used for keyword matching.
    - `match_score`, `success_probability`: Float fields computed by the `MatchingEngine`.
    - `checkin_ids`: One2many for weekly progress updates (WhatsApp integration source).
*   **Services Interaction**: Calls `ensa.matching.engine` in `calculate_match_score()` to process complex matching logic, keeping the model clean.
*   **AI Integration**: `analyze_progress_with_ai()` sends check-in text to an LLM to detect sentiment/risks.

### 3. `hr.employee` (Inherited in `models/employee.py`)
*   **Purpose**: Extends the standard employee to be an "Academic Staff" member.
*   **Key Fields**:
    - `skill_level`: Selection (Basic -> Expert). Used for filtering supervisors.
    - `performance_trend`: Computed field. Compares the last 2 evaluations to show a trend (ðŸ“ˆ or ðŸ“‰).
    - `whatsapp_number`: Used by `ensa.whatsapp.service` for notifications.
*   **Business Logic**: `_compute_performance_metrics` is a heavy method that aggregates data from the `ensa.evaluation` model to give a realtime performance snapshot.

### 4. `ensa.ai.assistant` (`models/ai_assistant.py`)
*   **Purpose**: Stores the conversation history and acts as the interface for the Chatbot.
*   **Mechanism**:
    1.  User asks a question.
    2.  `_gather_hr_context()` builds a huge JSON context of current DB stats (~50 lines of code).
    3.  Calls `ensa.ai.service.answer_query(question, context)`.
    4.  Saves the result and displays it.

---

## Part 4: Services & AI Logic

The module uses a **Service-Oriented Architecture** within Odoo models (`AbstractModel`) to decouple logic.

### 1. `ensa.ai.service` (`services/ai_service.py`)
*   **Role**: The Gateway to LLMs. It abstracts the provider (HuggingFace, Bytez, etc.).
*   **Key Methods**:
    - `generate_text(prompt)`: Handles caching, API calls, and error handling.
    - `detect_anomalies(data)`: Sends JSON data to AI and asks for pattern recognition.
*   **Why separated?**: If we switch from OpenAI to HuggingFace, we only change this file. The models (`employee.py`) don't need to know *which* AI is running.

### 2. `ensa.matching.engine` (`services/matching_engine.py`)
*   **Role**: Pure mathematical logic for matching.
*   **Logic**:
    - **Skill Match (40%)**: Jaccard Similarity (Intersection of sets).
    - **Semantic Match (30%)**: Cosine Similarity of embeddings (or text).
    - **Performance (20%)**: Normalized student grade.
    - **Level (10%)**: Exact match of academic year.
*   **Inputs**: Student Dictionary, Internship Dictionary.
*   **Output**: A detailed score dictionary including a recommendation string.

### 3. `ensa.document.generator` (`services/document_generator.py`)
*   **Role**: Dynamic text generation for reports.
*   **Usage**: When printing a certificate, it can generate a custom praise paragraph based on the student's specific project outcomes, rather than a hardcoded static text.

---

## Part 5: Views, UI & Dashboard

### 1. Menu Structure (`views/menu.xml`)
*   **Root**: `Ensa Hoceima HR`
    *   **Performance**: Evaluations.
    *   **Training**: Programs.
    *   **Students & Projects**: Internships, Projects, Certifications.
    *   **AI & Analytics**: Dashboard, Chatbot. (Restricted to Managers).
    *   **Configuration**: Settings.

### 2. Dashboard (`static/src/js/dashboard_controller.js`)
*   **Tech Stack**: Odoo Owl (Odoo Web Library) - a React-like component system.
*   **Flow**:
    1.  `onMounted` triggers `loadData()`.
    2.  `useRPC` calls the backend method `ensa.dashboard.get_dashboard_data`.
    3.  Data is stored in `this.state`.
    4.  The XML template (`DependatHRDashboard` - not shown in file list but referenced) renders the charts using `Chart.js`.
*   **AI Integration**: The controller fetches `ai_insights` from the backend, which are pre-generated string summaries displayed on the dashboard.

---

## Part 6: Security & Access Control

### 1. Groups (`security/security.xml`)
*   **HR User (Officer)**: Can Create/Edit data but cannot see full analytics or AI configs.
*   **HR Manager**: Full access, including AI settings and Dashboard.

### 2. Access Rights (`security/ir.model.access.csv`)
*   **Strict Access**:
    - `ensa.ai.service`: Only accessible by Code/System (no direct user access needed usually, but defined for transparency).
    - `ensa.evaluation`: Officers can Create/Read/Write. Managers can Delete (unlink).
*   **Pattern**: `model_name, group_id, 1, 1, 1, 1` (Read, Write, Create, Unlink).
    - Example: `access_ensa_dashboard_user` -> User group has `1,0,0,0` (Read Only).

